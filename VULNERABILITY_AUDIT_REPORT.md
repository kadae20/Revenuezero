# RevenueZero — Production Stability Audit Report

## ① checkUsageLimits() / Usage Logic

| 항목 | 상태 | 비고 |
|------|------|------|
| billing_cycle 기준 | ⚠️ | getSubscriptionByUserId에서 billing_cycle_end < now 시 reset 호출. billing_cycle_start가 아니라 end 기준 → **정확함** |
| invoice.paid에서 analyses=0 | ✅ | handleInvoicePaid → resetBillingCycle 호출함 |
| Race condition | ❌ | **취약**: incrementReportCount가 read-modify-write. 동시 요청 시 크레딧 이중 차감 또는 탈취 가능 |
| 무료 플랜 우회 | ✅ | userId 없으면 checkUsageLimits 미호출, rate limit만 적용. subscription 없으면 분석 불가 |
| status != active | ✅ | getSubscriptionByUserId가 active/trialing만 반환. past_due면 null → 분석 차단 |

---

## ② Stripe Webhook Idempotency

| 항목 | 상태 | 비고 |
|------|------|------|
| 이벤트 ID 저장 | ❌ | **취약**: processed event ID 저장 없음. 중복 수신 시 중복 처리 |
| plan downgrade | ✅ | handleSubscriptionUpdated에서 updateSubscriptionPlan 즉시 적용 |
| failed payment | ✅ | handleInvoiceFailed → past_due. getSubscriptionByUserId에서 제외 → 분석 차단 |

---

## ③ Public Profile Security

| 항목 | 상태 | 비고 |
|------|------|------|
| is_public=false 차단 | ✅ | getProjectBySlug에 .eq('is_public', true) 적용 |
| slug 추측/열거 | ⚠️ | slug에 랜덤 suffix 있으나, 짧은 slug 브루트포스 가능. rate limit 권장 |
| user_id 필터 | ✅ | public 조회 시 user_id 불필요. updateProject에 user_id 검증 있음 |

---

## ④ Billing Cycle Reset Edge Case

| 항목 | 상태 | 비고 |
|------|------|------|
| billing_cycle_end 지나면 자동 reset | ✅ | getSubscriptionByUserId에서 resetBillingCycle 호출 |
| invoice.paid 없이 무한 사용 | ⚠️ | getSubscriptionByUserId 진입 시 reset → **webhook 실패해도** reset됨. 악의적 사용자는 cycle_end 지나면 reset 후 재사용 가능. subscription이 active인 한 발생. 완전 차단하려면 webhook-only reset 필요하나, 그 경우 webhook 실패 시 정상 유저도 reset 안 됨 (tradeoff) |

---

## ⑤ Analysis API Race Condition

| 항목 | 상태 | 비고 |
|------|------|------|
| 동시 요청 시 차감 | ❌ | **취약**: incrementReportCount가 read 후 +1 update. 동시 N요청 시 N번 모두 check 통과 후, increment가 경쟁하여 1~N번 차감됨. 2번 분석에 1번만 차감 가능 (크레딧 탈취) |

---

## ⑥ Dashboard Score Calculation

| 항목 | 상태 | 비고 |
|------|------|------|
| currentScore 기준 | ✅ | latest = reports[reports.length - 1]. getAllReportsByProjectId는 version asc 정렬 → 마지막 = 최신 |
| trend 정확성 | ✅ | version ascending으로 정렬된 배열 사용 |
| null score | ✅ | latest?.score ?? null 처리 |

---

## Summary

| 우선순위 | 취약점 | 조치 | 상태 |
|----------|--------|------|------|
| P0 | Usage increment race condition | Atomic RPC (increment_report_usage 등) | ✅ 패치됨 |
| P0 | Webhook idempotency | webhook_events_processed 테이블 + event ID 체크 | ✅ 패치됨 |
| P1 | past_due 시 분석 차단 | getSubscriptionByUserId null = 차단 + 명시적 에러 | ✅ 패치됨 |
| P1 | Billing cycle | resetBillingCycle(periodEnd) - invoice.paid에서 Stripe period 사용 | ✅ 패치됨 |
| P2 | Public slug enumeration | slug 형식 검증 (8-80자, [a-z0-9-]+) | ✅ 패치됨 |

## Patches Applied

- **004_production_safety.sql**: webhook_events_processed, increment_report_usage, increment_reanalysis_usage, increment_projects_count RPC
- **webhookIdempotency.ts**: isEventProcessed, markEventProcessed
- **subscriptions.ts**: RPC 기반 atomic increment, resetBillingCycle(periodEnd)
- **webhooks/route.ts**: idempotency check, periodEnd 전달
- **analyze/route.ts**: subscription null 시 403
- **public-profile/route.ts**: slug 형식 검증
